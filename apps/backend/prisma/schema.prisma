// Cernio Database Schema
// Multi-tenant demolition contractor platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================
// Core Tables - Phase 0
// ===================================

model Company {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users          User[]
  auditEvents    AuditEvent[]
  clients        Client[]
  projects       Project[]
  inventoryItems InventoryItem[]

  @@map("companies")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String // Hashed with bcrypt
  firstName String
  lastName  String
  role      UserRole
  companyId String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sessions    Session[]
  auditEvents AuditEvent[]

  @@index([companyId])
  @@index([email])
  @@map("users")
}

enum UserRole {
  SYSTEM_ADMIN // SuperAdmin - access all companies
  COMPANY_ADMIN // Tenant admin - full control of their company
  USER // General user - standard permissions
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@map("sessions")
}

model AuditEvent {
  id         String   @id @default(cuid())
  companyId  String
  userId     String?
  eventType  String // e.g., "user.created", "project.updated"
  entityType String // e.g., "User", "Project"
  entityId   String
  changes    Json? // Store before/after data
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_events")
}

// ===================================
// Marketplace Customer Auth - Separate from Contractor Users
// ===================================

model MarketplaceUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String // Hashed with bcrypt
  firstName String
  lastName  String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions MarketplaceSession[]
  orders   Order[]

  @@index([email])
  @@map("marketplace_users")
}

model MarketplaceSession {
  id               String          @id @default(cuid())
  marketplaceUserId String
  refreshToken     String          @unique
  expiresAt        DateTime
  createdAt        DateTime        @default(now())

  // Relations
  marketplaceUser MarketplaceUser @relation(fields: [marketplaceUserId], references: [id], onDelete: Cascade)

  @@index([marketplaceUserId])
  @@index([refreshToken])
  @@map("marketplace_sessions")
}

model Order {
  id                String          @id @default(cuid())
  marketplaceUserId String
  inventoryItemId   String
  quantity          Decimal         @db.Decimal(10, 2)
  totalPrice        Decimal         @db.Decimal(12, 2)
  status            OrderStatus     @default(PENDING)

  // Customer details
  customerName      String
  customerEmail     String
  customerPhone     String?

  // Shipping/pickup
  shippingAddress   String?
  notes             String?         @db.Text

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  marketplaceUser   MarketplaceUser @relation(fields: [marketplaceUserId], references: [id], onDelete: Cascade)

  @@index([marketplaceUserId])
  @@index([inventoryItemId])
  @@index([status])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PAID
  SHIPPED
  COMPLETED
  CANCELLED
}

// ===================================
// Client Management - Phase 1
// ===================================

model Client {
  id        String     @id @default(cuid())
  companyId String
  name      String
  type      ClientType
  imageUrl  String?

  // International-friendly address fields
  street1    String
  street2    String?
  city       String
  state      String // State/Province/Region
  postalCode String
  country    String  @default("United States")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contacts ClientContact[]
  projects Project[]

  @@index([companyId])
  @@index([type])
  @@map("clients")
}

enum ClientType {
  RESIDENTIAL
  COMMERCIAL
  INDUSTRIAL
  MUNICIPAL
}

model ClientContact {
  id        String   @id @default(cuid())
  clientId  String
  name      String
  email     String?
  phone     String?
  role      String?
  imageUrl  String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("client_contacts")
}

// ===================================
// Project Management - Phase 2
// ===================================

model Project {
  id          String        @id @default(cuid())
  companyId   String
  clientId    String
  name        String
  description String?       @db.Text
  status      ProjectStatus @default(PLANNED)
  imageUrl    String?

  // Project location (may differ from client address)
  street1    String
  street2    String?
  city       String
  state      String
  postalCode String
  country    String  @default("United States")

  // Timeline
  startDate               DateTime?
  estimatedCompletionDate DateTime?
  actualCompletionDate    DateTime?

  // Budget tracking
  estimatedBudget Decimal? @db.Decimal(12, 2)
  actualCost      Decimal? @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  inventoryItems InventoryItem[]

  @@index([companyId])
  @@index([clientId])
  @@index([status])
  @@map("projects")
}

enum ProjectStatus {
  PLANNED
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

// ===================================
// Inventory Management - Phase 3
// ===================================

model InventoryItem {
  id        String  @id @default(cuid())
  companyId String
  projectId String? // Optional - some tools aren't project-specific

  // Core fields (all types)
  type        InventoryItemType
  name        String
  description String?           @db.Text
  quantity    Decimal           @db.Decimal(10, 2)
  unit        String // "lbs", "units", "hours", "sq ft"
  status      InventoryStatus

  // Type-specific fields (optional - depends on type)

  // Material-specific
  supplier         String?
  purchaseCost     Decimal?  @db.Decimal(12, 2)
  purchaseDate     DateTime?
  materialCategory String? // "Lumber", "Concrete", "Disposal", etc.

  // Tool-specific
  ownership       String? // "OWNED", "RENTED"
  rentalRate      Decimal?  @db.Decimal(10, 2)
  rentalPeriod    String? // "daily", "weekly", "monthly"
  maintenanceDate DateTime?
  serialNumber    String?

  // Salvage-specific
  condition       String? // "Excellent", "Good", "Fair", "As-Is"
  estimatedValue  Decimal? @db.Decimal(12, 2)
  reservePrice    Decimal? @db.Decimal(12, 2)
  dimensions      String?
  storageLocation String?

  // Common metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project Project?         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  photos  InventoryPhoto[]

  @@index([companyId])
  @@index([projectId])
  @@index([type])
  @@index([status])
  @@map("inventory_items")
}

enum InventoryItemType {
  MATERIAL // Things you buy and consume
  TOOL // Equipment you own or rent
  SALVAGE // Things you extract and sell
}

enum InventoryStatus {
  // Material statuses
  PURCHASED
  IN_STOCK
  CONSUMED

  // Tool statuses
  AVAILABLE
  ASSIGNED
  IN_USE
  MAINTENANCE

  // Salvage statuses
  ESTIMATED // Pre-extraction estimate - quantity may vary
  EXTRACTED
  AVAILABLE_FOR_SALE
  LISTED
  SOLD
  SHIPPED
}

model InventoryPhoto {
  id              String   @id @default(cuid())
  inventoryItemId String
  photoUrl        String
  isPrimary       Boolean  @default(false)
  displayOrder    Int      @default(0)
  uploadedAt      DateTime @default(now())

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([inventoryItemId])
  @@map("inventory_photos")
}
